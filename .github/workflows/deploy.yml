name: Deploy Odoo to VM

on:
  workflow_run:
    workflows: ["Run Odoo Tests"]
    branches: ["main"]
    types:
      - completed

jobs:
  deploy:
    name: Deploy to Odoo VM
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Deploy to VM
        uses: appleboy/ssh-action@v1.0.3
        env:
          ODOO_CONF: ${{ secrets.ODOO_CONF }}
        with:
          host: ${{ secrets.VM_IP }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 30m
          envs: ODOO_CONF
          script: |
            set -e
            cd ~/odoo-project || { mkdir -p ~/odoo-project && cd ~/odoo-project; }

            # Clone or update repository
            if [ ! -d ".git" ]; then
              echo "Cloning repository..."
              timeout 300 git clone --depth 1 -b main https://github.com/Cleardeals/Odoo-HRMS.git . || exit 1
            else
              echo "Updating repository..."
              timeout 300 git fetch --depth 1 origin main || exit 1
              git reset --hard origin/main
            fi

            echo "Creating odoo.conf..."
            echo "$ODOO_CONF" > odoo.conf

            echo "Rebuilding Docker image..."
            docker compose build odoo

            echo "Restarting containers..."
            docker compose up -d --force-recreate odoo

            echo "Cleaning up..."
            docker system prune -f

            echo "Deployment complete!"
