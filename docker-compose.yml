# ==============================================================================
# Odoo HRMS - Production Docker Compose
# ==============================================================================
# Optimized for e2-medium (2 vCPU, 4GB RAM)
# Stack: Traefik v3.0 + PostgreSQL 17 + Odoo 19
# ==============================================================================

services:
  # ----------------------------------------------------------------------------
  # Traefik Reverse Proxy
  # ----------------------------------------------------------------------------
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped

    command:
      # API & Dashboard
      - "--api.insecure=true"

      # Docker Provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=web"

      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"

      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"

      # Let's Encrypt configuration
      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      - "--certificatesresolvers.myresolver.acme.email=cdgcphub@gmail.com"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"

      # Logging
      - "--log.level=INFO"
      - "--accesslog=true"

    ports:
      - "80:80"       # HTTP
      - "443:443"     # HTTPS
      - "8080:8080"   # Traefik Dashboard (disable in production or add auth)

    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./letsencrypt:/letsencrypt"

    networks:
      - web

  # ----------------------------------------------------------------------------
  # PostgreSQL Database
  # ----------------------------------------------------------------------------
  db:
    image: postgres:17
    container_name: odoo-db
    restart: unless-stopped

    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: odoo
      POSTGRES_PASSWORD: ${DB_PASSWORD:-odoo}

    # Performance tuning for e2-medium (4GB RAM, ~1GB for Postgres)
    command: >
      postgres
      -c max_connections=60
      -c shared_buffers=512MB
      -c effective_cache_size=1536MB
      -c work_mem=32MB
      -c maintenance_work_mem=128MB
      -c wal_buffers=16MB
      -c synchronous_commit=off
      -c checkpoint_completion_target=0.9
      -c random_page_cost=1.1

    volumes:
      - ./odoo-db-data:/var/lib/postgresql/data

    networks:
      - web

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U odoo"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # ----------------------------------------------------------------------------
  # Odoo Application
  # ----------------------------------------------------------------------------
  odoo:
    build:
      context: .
      dockerfile: Dockerfile
    image: odoo-hrms:latest
    container_name: odoo-app
    restart: unless-stopped

    depends_on:
      db:
        condition: service_healthy

    environment:
      # Database connection
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: odoo
      DB_PASSWORD: ${DB_PASSWORD:-odoo}

      # Odoo proxy configuration
      ODOO_PROXY: "true"
      WEB_BASE_URL: https://hr.cleardeals.xyz

      # Optional: BigQuery/GCP credentials
      # GOOGLE_APPLICATION_CREDENTIALS: /run/secrets/gcp_credentials

    volumes:
      # Configuration (read-only for security)
      - ./odoo.conf:/etc/odoo/odoo.conf:ro

      # Persistent data
      - ./odoo-web-data:/var/lib/odoo

      # Custom addons (mounted for hot-reload)
      - ./custom_addons:/mnt/extra-addons/custom

      # Optional: GCP credentials
      # - ./gcp-credentials.json:/run/secrets/gcp_credentials:ro

    networks:
      - web

    labels:
      # Enable Traefik
      - "traefik.enable=true"

      # Main Odoo Router (HTTPS)
      - "traefik.http.routers.odoo.rule=Host(`hr.cleardeals.xyz`)"
      - "traefik.http.routers.odoo.entrypoints=websecure"
      - "traefik.http.routers.odoo.tls.certresolver=myresolver"
      - "traefik.http.routers.odoo.service=odoo-service"
      - "traefik.http.routers.odoo.priority=1"
      - "traefik.http.services.odoo-service.loadbalancer.server.port=8069"

      # Longpolling Router (WebSocket for real-time features)
      - "traefik.http.routers.odoo-chat.rule=Host(`hr.cleardeals.xyz`) && PathPrefix(`/longpolling`)"
      - "traefik.http.routers.odoo-chat.entrypoints=websecure"
      - "traefik.http.routers.odoo-chat.tls.certresolver=myresolver"
      - "traefik.http.routers.odoo-chat.service=odoo-chat-service"
      - "traefik.http.routers.odoo-chat.priority=2"
      - "traefik.http.services.odoo-chat-service.loadbalancer.server.port=8072"

      # Security Headers Middleware
      - "traefik.http.routers.odoo.middlewares=security-headers@docker"
      - "traefik.http.routers.odoo-chat.middlewares=security-headers@docker"

      - "traefik.http.middlewares.security-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.stsPreload=true"

# ==============================================================================
# Networks
# ==============================================================================
networks:
  web:
    driver: bridge
    name: web

